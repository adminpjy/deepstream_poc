<!DOCTYPE html>
<html>
<head>
    <title>AI智能分析系统</title>
    <meta charset="utf-8">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f4f6f9; display: flex; justify-content: center; align-items: flex-start; padding: 20px; box-sizing: border-box; }
        .container { display: flex; gap: 20px; width: 100%; max-width: 1600px; }
        .main-panel { flex: 3; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .log-panel { flex: 2; background-color: #2b303b; color: #c0c5ce; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 85vh; }
        h1, h2 { text-align: center; color: #333; }
        h2 { color: #e0e2e4; margin-top: 0; }
        .video-container { text-align: center; margin: 20px 0; background-color: #000; }
        #video-stream { max-width: 100%; border-radius: 5px; }
        .controls { text-align: center; margin: 20px 0; }
        button { padding: 10px 20px; margin: 0 10px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        #startBtn { background-color: #28a745; color: white; }
        #stopBtn { background-color: #dc3545; color: white; }
        .registration-form { display: none; background-color: #fffbe6; padding: 20px; border-radius: 5px; margin-top: 20px; border: 1px solid #ffeeba; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        #registerBtn { background-color: #007bff; color: white; }
        #cancelBtn { background-color: #6c757d; color: white; }
        .status { text-align: center; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .alert { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        #log-output { flex-grow: 1; overflow-y: auto; font-family: "SF Mono", "Consolas", "Menlo", monospace; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-break: break-all; }
        #log-output p { margin: 0; padding: 2px 0; border-bottom: 1px solid #3f4452; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-panel">
            <h1>AI智能分析系统</h1>
            <div class="controls">
                <button id="startBtn" onclick="startCamera()">启动摄像头</button>
                <button id="stopBtn" onclick="stopCamera()">停止摄像头</button>
            </div>
            <div id="status" class="status" style="display: none;"></div>
            <div class="video-container">
                <img id="video-stream" src="" alt="视频流">
            </div>
            <div id="registrationForm" class="registration-form">
                <h3>发现未知人员，是否注册？</h3>
                <div class="form-group"><label for="name">姓名:</label><input type="text" id="name" placeholder="请输入姓名"></div>
                <div class="form-group"><label for="employeeId">工号:</label><input type="text" id="employeeId" placeholder="请输入工号"></div>
                <button id="registerBtn" onclick="registerPerson()">注册</button>
                <button id="cancelBtn" onclick="cancelRegistration()">取消</button>
            </div>
        </div>
        <div class="log-panel">
            <h2>实时日志</h2>
            <div id="log-output"></div>
        </div>
    </div>

    <script>
        let checkingStatus = false;
        
        // (所有舊的JavaScript函數保持不變)
        function showStatus(message, type) { const statusDiv = document.getElementById('status'); statusDiv.textContent = message; statusDiv.className = 'status ' + type; statusDiv.style.display = 'block'; setTimeout(() => { statusDiv.style.display = 'none'; }, 3000); }
        function startCamera() { fetch('/start').then(response => response.json()).then(data => { if (data.success) { document.getElementById('video-stream').src = '/video_feed'; showStatus(data.message, 'success'); if (!checkingStatus) { checkingStatus = true; checkRegistrationStatus(); } } else { showStatus(data.message, 'alert'); } }); }
        function stopCamera() { fetch('/stop').then(response => response.json()).then(data => { document.getElementById('video-stream').src = ''; showStatus(data.message, 'success'); }); }
        function checkRegistrationStatus() { if (!checkingStatus) return; fetch('/status').then(response => response.json()).then(data => { const form = document.getElementById('registrationForm'); if (data.pending_registration) { form.style.display = 'block'; } else { form.style.display = 'none'; } }).finally(() => { if (checkingStatus) { setTimeout(checkRegistrationStatus, 1000); } }); }
        function registerPerson() { const name = document.getElementById('name').value; const employeeId = document.getElementById('employeeId').value; if (!name || !employeeId) { showStatus('请填写姓名和工号', 'alert'); return; } fetch('/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: name, employee_id: employeeId }) }).then(response => response.json()).then(data => { if (data.success) { showStatus(data.message, 'success'); document.getElementById('registrationForm').style.display = 'none'; document.getElementById('name').value = ''; document.getElementById('employeeId').value = ''; } else { showStatus(data.message, 'alert'); } }); }
        function cancelRegistration() { document.getElementById('registrationForm').style.display = 'none'; document.getElementById('name').value = ''; document.getElementById('employeeId').value = ''; }
        
        // --- 新增：日誌流處理邏輯 ---
        function setupLogStream() {
            const logOutput = document.getElementById('log-output');
            const evtSource = new EventSource("/log_stream");

            evtSource.onmessage = function(event) {
                const newLog = document.createElement("p");
                newLog.innerHTML = event.data; // 使用innerHTML來解析<br>換行符
                logOutput.appendChild(newLog);
                logOutput.scrollTop = logOutput.scrollHeight; // 自動滾動到底部
            };

            evtSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                const errorLog = document.createElement("p");
                errorLog.textContent = "--- 日誌流已斷開，請刷新頁面。 ---";
                errorLog.style.color = "#ff6b6b";
                logOutput.appendChild(errorLog);
                evtSource.close();
            };
        }

        window.onload = function() {
            startCamera();
            setupLogStream(); // 頁面加載時，同時啟動日誌流
        };
        
        window.onbeforeunload = function() {
            checkingStatus = false;
        };
    </script>
</body>
</html>